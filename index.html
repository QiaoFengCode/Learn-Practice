<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20ä»¥å†…å£ç®—è¯­éŸ³æŒ‘æˆ˜ (æƒé™å¢å¼ºç‰ˆ)</title>
    <style>
        /* (CSSæ ·å¼ä¿æŒä¸å˜ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹…) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            width: 400px;
            max-width: 90%;
            transition: background-color 0.3s;
        }

        h1 { color: #333; margin-bottom: 20px; font-size: 28px;}

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: #666;
            font-weight: bold;
            font-size: 18px;
        }

        .question-box {
            font-size: 56px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-box {
            font-size: 24px;
            color: #e74c3c;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .answer-display {
            font-size: 20px;
            color: #3498db;
            min-height: 30px;
            margin-bottom: 20px;
            font-style: italic;
        }

        .btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, background-color 0.2s;
        }

        .btn:active { transform: scale(0.95); }
        .btn:hover { background-color: #27ae60; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .result-msg {
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
            height: 40px;
        }
        
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }

        #mic-status {
            margin-top: 15px;
            font-size: 14px;
            color: #888;
        }
        
        .pulsating { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); color: #e74c3c; }
            50% { transform: scale(1.1); color: #c0392b; }
            100% { transform: scale(1); color: #e74c3c; }
        }

        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        .pop { animation: pop 0.3s; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <h1>ğŸ”Š 20ä»¥å†…å£ç®—æŒ‘æˆ˜</h1>
    
    <div class="status-bar">
        <span id="progress">é¢˜ç›®: 0 / 20</span>
        <span id="score">å¾—åˆ†: 0</span>
    </div>

    <div class="timer-box" id="timer">å‡†å¤‡å¼€å§‹</div>
    <div class="question-box" id="question">?</div>
    <div class="answer-display" id="user-input">ç‚¹å‡»æŒ‰é’®å¼€å§‹</div>
    <div class="result-msg" id="feedback"></div>

    <button class="btn" id="start-btn" onclick="startGame()">å¼€å§‹æµ‹è¯•</button>
    <div id="mic-status">é¦–æ¬¡å¯åŠ¨éœ€è¦éº¦å…‹é£æƒé™ï¼Œè¯·ç‚¹å‡»å…è®¸ã€‚</div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const MAX_QUESTIONS = 20;
    const TIME_LIMIT = 10;
    const SCORE_PER_QUESTION = 5;
    const TTS_DELAY_MS_PC = 300;  
    const TTS_DELAY_MS_MOBILE = 1500; 
    const MIC_RESTART_DELAY = 500; 
    
    // ================= çŠ¶æ€å˜é‡ =================
    let currentQuestionIndex = 0;
    let score = 0;
    let currentAnswer = 0;
    let timerInterval;
    let timeLeft = TIME_LIMIT;
    let isListening = false; 
    let recognition = null; 
    let audioCtx = null; 
    let micStartTimer = null; 
    let currentRecognitionStarted = false; 
    
    let restartCounter = 0; 
    const MAX_RESTARTS = 3; 

    // ä¸­æ–‡æ•°å­—æ˜ å°„
    const cnNums = {
        'é›¶':0, 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10,
        'åä¸€':11, 'åäºŒ':12, 'åä¸‰':13, 'åå››':14, 'åäº”':15, 'åå…­':16, 'åä¸ƒ':17, 'åå…«':18, 'åä¹':19, 'äºŒå':20,
        'ä¸¤': 2
    };

    /** è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ */
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    /** å…œåº•è‡ªåŠ¨é‡å¯å‡½æ•° */
    function autoRestart() {
        if (isListening && timeLeft > 0) {
            restartCounter++;
            
            if (restartCounter >= MAX_RESTARTS) {
                console.error("Critical Error: Max restart attempts reached. Stopping auto-restart.");
                document.getElementById('mic-status').innerHTML = '<span style="color:red;">ğŸš¨ é”™è¯¯ï¼šéº¦å…‹é£æ— æ³•ç¨³å®šå¯åŠ¨ï¼è¯·æ£€æŸ¥æµè§ˆå™¨åœ°å€æ çš„éº¦å…‹é£æƒé™å›¾æ ‡ã€‚</span>';
                isListening = false;
                clearInterval(timerInterval);
                return;
            }

            console.warn(`Unexpected recognition end detected. Attempting restart ${restartCounter}/${MAX_RESTARTS}...`);
            document.getElementById('mic-status').innerText = `ğŸ™ï¸ ç›‘å¬ä¸­æ–­ï¼Œè‡ªåŠ¨é‡å¯ä¸­... (${restartCounter}/${MAX_RESTARTS})`;
            
            clearTimeout(micStartTimer);
            micStartTimer = setTimeout(startListening, MIC_RESTART_DELAY); 
        } else {
            document.getElementById('mic-status').innerText = "ğŸ™ï¸ çŠ¶æ€ï¼šå°±ç»ª";
            restartCounter = 0; 
        }
    }
    
    // ================= è¯­éŸ³è¯†åˆ«åˆå§‹åŒ– (åªæ‰§è¡Œä¸€æ¬¡) =================
    function initSpeech() {
        if (recognition) return;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.continuous = true; 

            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        processVoiceInput(finalTranscript);
                        stopListening(); 
                        break; 
                    }
                }
            };

            recognition.onerror = function(event) {
                console.log("Speech error:", event.error);
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    // ã€æƒé™æ‹’ç»ã€‘ç«‹å³ç»™å‡ºæ˜ç¡®æç¤º
                    document.getElementById('mic-status').innerHTML = '<span style="color:red; font-weight:bold;">ğŸš¨ æƒé™è¢«æ‹’ï¼è¯·ç‚¹å‡»åœ°å€æ çš„éº¦å…‹é£å›¾æ ‡å¯ç”¨ã€‚</span>';
                    stopListening(true); 
                } else if (event.error === 'no-speech') {
                    // è§£å†³æ— è¯­éŸ³è¾“å…¥å¯¼è‡´çš„ä¸­æ–­ï¼Œè®© autoRestart å¤„ç†é‡å¯
                    document.getElementById('mic-status').innerText = "ğŸ™ï¸ æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œæ­£åœ¨é‡è¯•...";
                }
                // ç¡®ä¿åœ¨ä»»ä½•é”™è¯¯åï¼Œonend éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œè§¦å‘ autoRestart
            };
            
            recognition.onend = function() {
                currentRecognitionStarted = false;
                autoRestart(); 
            };

            recognition.onstart = function() {
                currentRecognitionStarted = true;
                restartCounter = 0; 
                document.getElementById('mic-status').innerText = "ğŸ™ï¸ çŠ¶æ€ï¼šæ¿€æ´»ä¸­";
                playReadyTone(); 
            };

        } else {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚");
            document.getElementById('start-btn').disabled = true;
        }
    }

    /** åœæ­¢éº¦å…‹é£ç›‘å¬ */
    function stopListening(force = false) {
        if (!recognition || !currentRecognitionStarted) return;
        try {
            isListening = false; 
            recognition.stop();
            currentRecognitionStarted = false; 
            document.getElementById('mic-status').innerText = "ğŸ™ï¸ çŠ¶æ€ï¼šå·²åœæ­¢";
            
            if (force) {
                clearTimeout(micStartTimer);
            }
        } catch(e) {
             console.log("Error stopping recognition:", e);
        }
    }

    /** å°è¯•å¯åŠ¨éº¦å…‹é£ */
    function startListening() {
        if (!recognition) return;
        if (currentRecognitionStarted || (recognition && recognition.readyState === recognition.STARTING)) {
            console.warn("Recognition already starting or started. Aborting start attempt.");
            return;
        }

        isListening = true;
        document.getElementById('user-input').innerText = "ğŸ‘‚ æ­£åœ¨å¬... è¯·å›ç­”";
        
        try {
            clearTimeout(micStartTimer); 
            recognition.start();
        } catch(e) {
            // æ•è·æƒé™è¢«æ‹’æˆ–çŠ¶æ€é”™è¯¯
            if (e.name === 'InvalidStateError') {
                // å¦‚æœæ˜¯çŠ¶æ€é”™è¯¯ï¼Œå°è¯•é‡å¯
                recognition.onend(); 
            } else if (e.name === 'SecurityError') {
                // æƒé™è¢«é˜»æ­¢ï¼Œç›´æ¥æŠ¥é”™
                document.getElementById('mic-status').innerHTML = '<span style="color:red; font-weight:bold;">ğŸš¨ æƒé™è¢«æ‹’ï¼è¯·ç‚¹å‡»åœ°å€æ çš„éº¦å…‹é£å›¾æ ‡å¯ç”¨ã€‚</span>';
                stopListening(true);
            } else {
                console.error("Failed to start recognition:", e);
                document.getElementById('mic-status').innerText = "å¯åŠ¨éº¦å…‹é£å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚";
            }
        }
    }
    
    // ================= (TTS, Audio, æ ¸å¿ƒé€»è¾‘ä»£ç ä¿æŒä¸å˜ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹…) =================
    
    // [TTS code: readQuestion]
    function readQuestion(text) {
        window.speechSynthesis.cancel(); 
        
        const delay = isMobileDevice() ? TTS_DELAY_MS_MOBILE : TTS_DELAY_MS_PC;

        if ('speechSynthesis' in window) {
            const speakText = text.replace(/\+/g, 'åŠ ').replace(/-/g, 'å‡') + "ç­‰äºå¤šå°‘?";
            
            const utterance = new SpeechSynthesisUtterance(speakText);
            utterance.lang = 'zh-CN';
            
            utterance.onend = () => {
                micStartTimer = setTimeout(startListening, delay); 
            };
            utterance.onerror = () => {
                micStartTimer = setTimeout(startListening, delay);
            };

            window.speechSynthesis.speak(utterance);
        } else {
            micStartTimer = setTimeout(startListening, delay);
        }
    }
    
    // [Audio Code: initAudio, playSound, playReadyTone]
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playSound(type) {
        if (!audioCtx) initAudio();
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'correct') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(500, now);
            oscillator.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            oscillator.start(now);
            oscillator.stop(now + 0.5);
        } else if (type === 'wrong') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, now);
            oscillator.frequency.linearRampToValueAtTime(100, now + 0.3);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
        } else if (type === 'tick') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(800, now);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            oscillator.start(now);
            oscillator.stop(now + 0.05);
        } else if (type === 'end') {
            [0, 0.2, 0.4].forEach((offset, i) => {
                const osc = audioCtx.createOscillator();
                const gn = audioCtx.createGain();
                osc.connect(gn);
                gn.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.value = 400 + (i * 100);
                gn.gain.setValueAtTime(0.3, now + offset);
                gn.gain.linearRampToValueAtTime(0, now + offset + 0.3);
                osc.start(now + offset);
                osc.stop(now + offset + 0.3);
            });
        }
    }
    
    function playReadyTone() {
        if (!audioCtx) initAudio();
        const now = audioCtx.currentTime;
        const duration = 0.1;
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1200, now);
        gainNode.gain.setValueAtTime(0.3, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);

        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    // [Core Logic: parseNumber, startGame, generateMathProblem, nextQuestion, processVoiceInput, handleAnswer, endGame]

    function parseNumber(str) {
        str = str.replace(/[ã€‚ï¼Œï¼Ÿï¼]/g, '');
        let num = parseInt(str);
        if (!isNaN(num)) return num;
        if (cnNums[str] !== undefined) return cnNums[str];
        for (let key in cnNums) {
            if (str.includes(key)) return cnNums[key];
        }
        let match = str.match(/\d+/);
        if (match) return parseInt(match[0]);
        return null;
    }

    function startGame() {
        initAudio(); 
        initSpeech(); 
        score = 0;
        currentQuestionIndex = 0;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
        nextQuestion();
    }

    function generateMathProblem() {
        let isChain = Math.random() > 0.7;
        let num1 = Math.floor(Math.random() * 21);
        let num2 = Math.floor(Math.random() * 21);
        let op1 = Math.random() > 0.5 ? '+' : '-';
        
        let result = op1 === '+' ? num1 + num2 : num1 - num2;
        let expression = `${num1} ${op1} ${num2}`;

        if (result < 0 || result > 20) return generateMathProblem();

        if (isChain) {
            let num3 = Math.floor(Math.random() * 21);
            let op2 = Math.random() > 0.5 ? '+' : '-';
            let tempResult = op2 === '+' ? result + num3 : result - num3;
            
            if (tempResult < 0 || tempResult > 20) return generateMathProblem();
            result = tempResult;
            expression += ` ${op2} ${num3}`;
        }
        return { expression, result };
    }

    function nextQuestion() {
        if (currentQuestionIndex >= MAX_QUESTIONS) {
            endGame();
            return;
        }

        currentQuestionIndex++;
        
        stopListening();
        clearTimeout(micStartTimer);
        window.speechSynthesis.cancel();
        
        restartCounter = 0; 

        document.getElementById('main-box').style.backgroundColor = 'white';
        document.getElementById('progress').innerText = `é¢˜ç›®: ${currentQuestionIndex} / ${MAX_QUESTIONS}`;
        document.getElementById('feedback').innerText = "";
        document.getElementById('user-input').innerText = "ğŸ”Š ç”µè„‘æ­£åœ¨è¯»é¢˜...";
        document.getElementById('mic-status').innerText = "çŠ¶æ€ï¼šç­‰å¾…æœ—è¯»ç»“æŸ";
        
        let problem = generateMathProblem();
        currentAnswer = problem.result;
        
        const qBox = document.getElementById('question');
        qBox.innerText = `${problem.expression} = ?`;
        qBox.classList.remove('pop');
        void qBox.offsetWidth;
        qBox.classList.add('pop');

        timeLeft = TIME_LIMIT;
        document.getElementById('timer').innerText = `â±ï¸ ${timeLeft}s`;
        document.getElementById('timer').classList.remove('pulsating');
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `â±ï¸ ${timeLeft}s`;
            
            if (timeLeft <= 3 && timeLeft > 0) {
                document.getElementById('timer').classList.add('pulsating');
                playSound('tick');
            }

            if (timeLeft <= 0) {
                handleAnswer(null, true);
            }
        }, 1000);

        readQuestion(problem.expression);
    }

    function processVoiceInput(transcript) {
        let userVal = parseNumber(transcript);
        document.getElementById('user-input').innerText = `ä½ è¯´: "${transcript}"`;
        
        if (userVal !== null) {
            handleAnswer(userVal, false);
        }
    }

    function handleAnswer(value, isTimeout) {
        clearInterval(timerInterval);
        stopListening(); 
        clearTimeout(micStartTimer);
        window.speechSynthesis.cancel();

        const feedbackEl = document.getElementById('feedback');
        const mainBox = document.getElementById('main-box');
        
        if (isTimeout) {
            playSound('wrong');
            feedbackEl.innerHTML = `<span class="wrong">è¶…æ—¶äº†! ç­”æ¡ˆæ˜¯ ${currentAnswer}</span>`;
            mainBox.style.backgroundColor = '#fdeea6';
        } else if (value === currentAnswer) {
            playSound('correct');
            score += SCORE_PER_QUESTION;
            feedbackEl.innerHTML = `<span class="correct">å›ç­”æ­£ç¡®! +${SCORE_PER_QUESTION}åˆ†</span>`;
            mainBox.style.backgroundColor = '#d5f5e3';
        } else {
            playSound('wrong');
            score = Math.max(0, score - 1);
            feedbackEl.innerHTML = `<span class="wrong">ä¸å¯¹å“¦! ç­”æ¡ˆæ˜¯ ${currentAnswer} (-1åˆ†)</span>`;
            mainBox.classList.add('shake');
            setTimeout(()=>mainBox.classList.remove('shake'), 500);
            mainBox.style.backgroundColor = '#fadbd8';
        }

        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;

        setTimeout(nextQuestion, 2000);
    }

    function endGame() {
        clearInterval(timerInterval);
        stopListening(true); 
        clearTimeout(micStartTimer);
        window.speechSynthesis.cancel();
        playSound('end');
        
        let comment = "";
        if(score === MAX_QUESTIONS * SCORE_PER_QUESTION) comment = "å¤ªç¥äº†ï¼æ»¡åˆ†ï¼ğŸ†";
        else if(score >= (MAX_QUESTIONS * SCORE_PER_QUESTION) * 0.8) comment = "éå¸¸æ£’ï¼ç»§ç»­åŠ æ²¹ï¼ğŸŒŸ";
        else comment = "è¿˜éœ€ç»ƒä¹ å“¦ ğŸ’ª";

        document.querySelector('.container').innerHTML = `
            <h1>ğŸ‰ æµ‹è¯•å®Œæˆ!</h1>
            <div style="font-size:60px; color:#2c3e50; margin:20px 0;">${score}åˆ†</div>
            <p style="font-size:20px; color:#666;">${comment}</p>
            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        `;
    }
</script>

</body>
</html>