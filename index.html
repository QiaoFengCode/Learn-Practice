<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20ä»¥å†…å£ç®—è¯­éŸ³æŒ‘æˆ˜ (é«˜ç¨³å®šæ€§ç‰ˆ)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            width: 400px;
            max-width: 90%;
            transition: background-color 0.3s;
        }

        h1 { color: #333; margin-bottom: 20px; font-size: 28px;}

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: #666;
            font-weight: bold;
            font-size: 18px;
        }

        .question-box {
            font-size: 56px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-box {
            font-size: 24px;
            color: #e74c3c;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .answer-display {
            font-size: 20px;
            color: #3498db;
            min-height: 30px;
            margin-bottom: 20px;
            font-style: italic;
        }

        .btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, background-color 0.2s;
        }

        .btn:active { transform: scale(0.95); }
        .btn:hover { background-color: #27ae60; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .result-msg {
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
            height: 40px;
        }
        
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }

        #mic-status {
            margin-top: 15px;
            font-size: 14px;
            color: #888;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .pulsating { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); color: #e74c3c; }
            50% { transform: scale(1.1); color: #c0392b; }
            100% { transform: scale(1); color: #e74c3c; }
        }

        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        .pop { animation: pop 0.3s; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <h1>ğŸ”Š 20ä»¥å†…å£ç®—æŒ‘æˆ˜</h1>
    
    <div class="status-bar">
        <span id="progress">é¢˜ç›®: 0 / 20</span>
        <span id="score">å¾—åˆ†: 0</span>
    </div>

    <div class="timer-box" id="timer">å‡†å¤‡å¼€å§‹</div>
    <div class="question-box" id="question">?</div>
    <div class="answer-display" id="user-input">ç‚¹å‡»æŒ‰é’®å¼€å§‹</div>
    <div class="result-msg" id="feedback"></div>

    <button class="btn" id="start-btn" onclick="startGame()">å¼€å§‹æµ‹è¯•</button>
    <div id="mic-status">é¦–æ¬¡å¯åŠ¨éœ€è¦éº¦å…‹é£æƒé™ï¼Œè¯·ç‚¹å‡»å…è®¸ã€‚</div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const MAX_QUESTIONS = 20;
    const TIME_LIMIT = 10;
    const SCORE_PER_QUESTION = 5;

    // ================= çŠ¶æ€å˜é‡ =================
    let currentQuestionIndex = 0;
    let score = 0;
    let currentAnswer = 0;
    let timerInterval;
    let timeLeft = TIME_LIMIT;
    let isListening = false;
    let recognition = null; 
    let audioCtx = null; 
    let micStartTimer = null; 

    // ä¸­æ–‡æ•°å­—æ˜ å°„
    const cnNums = {
        'é›¶':0, 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10,
        'åä¸€':11, 'åäºŒ':12, 'åä¸‰':13, 'åå››':14, 'åäº”':15, 'åå…­':16, 'åä¸ƒ':17, 'åå…«':18, 'åä¹':19, 'äºŒå':20,
        'ä¸¤': 2
    };

    // ================= è¯­éŸ³è¯†åˆ«åˆå§‹åŒ– (åªæ‰§è¡Œä¸€æ¬¡) =================
    function initSpeech() {
        if (recognition) return;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            // æé«˜è¶…æ—¶æ—¶é—´ (é»˜è®¤é€šå¸¸æ˜¯ 5sï¼Œè®¾ä¸º 10s åŒ¹é…ç­”é¢˜æ—¶é—´)
            recognition.maxAlternatives = 1;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                processVoiceInput(transcript);
            };

            recognition.onerror = function(event) {
                console.log("Speech error:", event.error);
                if (event.error !== 'no-speech' && event.error !== 'audio-capture') {
                     document.getElementById('mic-status').innerText = "éº¦å…‹é£å‡ºé”™: " + event.error;
                }
            };
            
            // ã€å…³é”®ä¼˜åŒ– 1ã€‘: å¼ºåˆ¶é‡å¯é€»è¾‘
            recognition.onend = function() {
                // å¦‚æœè¿˜åœ¨ç›‘å¬çŠ¶æ€ä¸”æ—¶é—´æœªåˆ°ï¼Œç­‰å¾…ç‰‡åˆ»åå¼ºåˆ¶é‡å¯
                if (isListening && timeLeft > 0) {
                    clearTimeout(micStartTimer);
                    // å¼ºåˆ¶å»¶è¿Ÿ 200ms å¯åŠ¨ï¼Œé˜²æ­¢èµ„æºå†²çª
                    micStartTimer = setTimeout(startListening, 200); 
                }
            };

        } else {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚");
            document.getElementById('start-btn').disabled = true;
        }
    }

    // å°è¯•å¯åŠ¨éº¦å…‹é£
    function startListening() {
        if (!recognition) return;
        isListening = true;
        document.getElementById('user-input').innerText = "ğŸ‘‚ æ­£åœ¨å¬... è¯·å›ç­”";
        document.getElementById('mic-status').innerText = "ğŸ™ï¸ çŠ¶æ€ï¼šæ¿€æ´»ä¸­";
        
        try {
            recognition.start();
        } catch(e) {
            if (e.name !== 'InvalidStateError') {
                console.error("Failed to start recognition:", e);
                document.getElementById('mic-status').innerText = "å¯åŠ¨éº¦å…‹é£å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚";
            }
        }
    }

    // ================= è¯­éŸ³æœ—è¯» (Text-to-Speech) =================
    function readQuestion(text) {
        window.speechSynthesis.cancel(); 
        
        if ('speechSynthesis' in window) {
            const speakText = text.replace(/\+/g, 'åŠ ').replace(/-/g, 'å‡') + "ç­‰äºå¤šå°‘?";
            
            const utterance = new SpeechSynthesisUtterance(speakText);
            utterance.lang = 'zh-CN';
            
            utterance.onend = () => {
                // ã€å…³é”®ä¼˜åŒ– 2ã€‘: å»¶è¿Ÿ 1000ms å¯åŠ¨ï¼Œç»™ç³»ç»Ÿå……è¶³æ—¶é—´åˆ‡æ¢éŸ³é¢‘èµ„æº
                clearTimeout(micStartTimer);
                micStartTimer = setTimeout(startListening, 1000); 
            };
            utterance.onerror = () => {
                // å¦‚æœæœ—è¯»å¤±è´¥ï¼Œä¹Ÿè¦å»¶è¿Ÿå¯åŠ¨éº¦å…‹é£
                clearTimeout(micStartTimer);
                micStartTimer = setTimeout(startListening, 1000);
            };

            window.speechSynthesis.speak(utterance);
        } else {
            // å¦‚æœä¸æ”¯æŒ TTSï¼Œç›´æ¥å¯åŠ¨éº¦å…‹é£ (æ— å»¶è¿Ÿ)
            startListening();
        }
    }

    // ================= éŸ³æ•ˆç³»ç»Ÿ (Web Audio API) =================
    function initAudio() {
        if (!audioCtx) {
            // å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’ååˆå§‹åŒ–ï¼ŒstartGame()ä¸­å·²è°ƒç”¨
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playSound(type) {
        if (!audioCtx) initAudio();
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'correct') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(500, now);
            oscillator.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            oscillator.start(now);
            oscillator.stop(now + 0.5);
        } else if (type === 'wrong') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, now);
            oscillator.frequency.linearRampToValueAtTime(100, now + 0.3);
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
        } else if (type === 'tick') {
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(800, now);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            oscillator.start(now);
            oscillator.stop(now + 0.05);
        } else if (type === 'end') {
            [0, 0.2, 0.4].forEach((offset, i) => {
                const osc = audioCtx.createOscillator();
                const gn = audioCtx.createGain();
                osc.connect(gn);
                gn.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.value = 400 + (i * 100);
                gn.gain.setValueAtTime(0.3, now + offset);
                gn.gain.linearRampToValueAtTime(0, now + offset + 0.3);
                osc.start(now + offset);
                osc.stop(now + offset + 0.3);
            });
        }
    }
    // ================= æ ¸å¿ƒé€»è¾‘ =================

    function parseNumber(str) {
        str = str.replace(/[ã€‚ï¼Œï¼Ÿï¼]/g, '');
        let num = parseInt(str);
        if (!isNaN(num)) return num;
        if (cnNums[str] !== undefined) return cnNums[str];
        for (let key in cnNums) {
            if (str.includes(key)) return cnNums[key];
        }
        let match = str.match(/\d+/);
        if (match) return parseInt(match[0]);
        return null;
    }

    function startGame() {
        initAudio(); 
        initSpeech(); 
        score = 0;
        currentQuestionIndex = 0;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
        nextQuestion();
    }

    function generateMathProblem() {
        let isChain = Math.random() > 0.7;
        let num1 = Math.floor(Math.random() * 21);
        let num2 = Math.floor(Math.random() * 21);
        let op1 = Math.random() > 0.5 ? '+' : '-';
        
        let result = op1 === '+' ? num1 + num2 : num1 - num2;
        let expression = `${num1} ${op1} ${num2}`;

        if (result < 0 || result > 20) return generateMathProblem();

        if (isChain) {
            let num3 = Math.floor(Math.random() * 21);
            let op2 = Math.random() > 0.5 ? '+' : '-';
            let tempResult = op2 === '+' ? result + num3 : result - num3;
            
            if (tempResult < 0 || tempResult > 20) return generateMathProblem();
            result = tempResult;
            expression += ` ${op2} ${num3}`;
        }
        return { expression, result };
    }

    function nextQuestion() {
        if (currentQuestionIndex >= MAX_QUESTIONS) {
            endGame();
            return;
        }

        currentQuestionIndex++;
        
        // 1. åœæ­¢ä¸Šä¸€ä¸ªç›‘å¬å‘¨æœŸ
        isListening = false;
        clearTimeout(micStartTimer);
        try { recognition.stop(); } catch(e) {}
        window.speechSynthesis.cancel();

        // 2. UI æ›´æ–° & é¢˜ç›®ç”Ÿæˆ
        document.getElementById('main-box').style.backgroundColor = 'white';
        document.getElementById('progress').innerText = `é¢˜ç›®: ${currentQuestionIndex} / ${MAX_QUESTIONS}`;
        document.getElementById('feedback').innerText = "";
        document.getElementById('user-input').innerText = "ğŸ”Š ç”µè„‘æ­£åœ¨è¯»é¢˜...";
        document.getElementById('mic-status').innerText = "çŠ¶æ€ï¼šç­‰å¾…æœ—è¯»ç»“æŸ";
        
        let problem = generateMathProblem();
        currentAnswer = problem.result;
        
        const qBox = document.getElementById('question');
        qBox.innerText = `${problem.expression} = ?`;
        qBox.classList.remove('pop');
        void qBox.offsetWidth;
        qBox.classList.add('pop');

        // 3. é‡ç½®è®¡æ—¶å™¨ 
        timeLeft = TIME_LIMIT;
        document.getElementById('timer').innerText = `â±ï¸ ${timeLeft}s`;
        document.getElementById('timer').classList.remove('pulsating');
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `â±ï¸ ${timeLeft}s`;
            
            if (timeLeft <= 3 && timeLeft > 0) {
                document.getElementById('timer').classList.add('pulsating');
                playSound('tick');
            }

            if (timeLeft <= 0) {
                handleAnswer(null, true);
            }
        }, 1000);

        // 4. è¯»é¢˜ï¼Œè¯»å®Œåå¯åŠ¨éº¦å…‹é£ç›‘å¬
        readQuestion(problem.expression);
    }

    function processVoiceInput(transcript) {
        let userVal = parseNumber(transcript);
        document.getElementById('user-input').innerText = `ä½ è¯´: "${transcript}"`;
        
        if (userVal !== null) {
            handleAnswer(userVal, false);
        }
    }

    function handleAnswer(value, isTimeout) {
        // åœæ­¢æ‰€æœ‰æµç¨‹
        clearInterval(timerInterval);
        isListening = false;
        clearTimeout(micStartTimer);
        
        try { recognition.stop(); } catch(e) {} 
        window.speechSynthesis.cancel();

        const feedbackEl = document.getElementById('feedback');
        const mainBox = document.getElementById('main-box');
        
        if (isTimeout) {
            playSound('wrong');
            feedbackEl.innerHTML = `<span class="wrong">è¶…æ—¶äº†! ç­”æ¡ˆæ˜¯ ${currentAnswer}</span>`;
            mainBox.style.backgroundColor = '#fdeea6';
        } else if (value === currentAnswer) {
            playSound('correct');
            score += SCORE_PER_QUESTION;
            feedbackEl.innerHTML = `<span class="correct">å›ç­”æ­£ç¡®! +${SCORE_PER_QUESTION}åˆ†</span>`;
            mainBox.style.backgroundColor = '#d5f5e3';
        } else {
            playSound('wrong');
            score = Math.max(0, score - 1);
            feedbackEl.innerHTML = `<span class="wrong">ä¸å¯¹å“¦! ç­”æ¡ˆæ˜¯ ${currentAnswer} (-1åˆ†)</span>`;
            mainBox.classList.add('shake');
            setTimeout(()=>mainBox.classList.remove('shake'), 500);
            mainBox.style.backgroundColor = '#fadbd8';
        }

        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;

        setTimeout(nextQuestion, 2000);
    }

    function endGame() {
        clearInterval(timerInterval);
        clearTimeout(micStartTimer);
        try { recognition.stop(); } catch(e) {}
        window.speechSynthesis.cancel();
        playSound('end');
        
        let comment = "";
        if(score === MAX_QUESTIONS * SCORE_PER_QUESTION) comment = "å¤ªç¥äº†ï¼æ»¡åˆ†ï¼ğŸ†";
        else if(score >= (MAX_QUESTIONS * SCORE_PER_QUESTION) * 0.8) comment = "éå¸¸æ£’ï¼ç»§ç»­åŠ æ²¹ï¼ğŸŒŸ";
        else comment = "è¿˜éœ€ç»ƒä¹ å“¦ ğŸ’ª";

        document.querySelector('.container').innerHTML = `
            <h1>ğŸ‰ æµ‹è¯•å®Œæˆ!</h1>
            <div style="font-size:60px; color:#2c3e50; margin:20px 0;">${score}åˆ†</div>
            <p style="font-size:20px; color:#666;">${comment}</p>
            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        `;
    }
</script>

</body>
</html>